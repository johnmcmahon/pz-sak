@Library('pipelib') _

node {
// ('sl61')
  def nodejs = tool 'Node 5.10.0'

  stage('Setup') {
    git([
      url: "https://github.com/venicegeo/pz-sak",
      branch: "master"
    ])
  }

  stage('Archive') {
    npmSetup()

    withEnv(["PATH+=${nodejs}/bin"]) {
      sh 'npm install'
      sh './ci/archive.sh'
    }

    mavenPush()
  }

  stage('Initial Scans') {
    dependencyCheck()

    // Where do unit tests (karma) run?

    // For sonar in the past, we run karma tests that generates lcov.info
    // and then our sonar-project.properties file says where that file is.
    // Rather than run sonar() I guess we should continue doing that
    sh './ci/sonar.sh'
  }

  stage ('CI Deploy') {
    cfPush()
    zap()
    cfBgDeploy()
  }

  stage ('Integration Testing') {
    postman()
  }

  stage('Staging Deploy') {
    cfPush {
      cfTarget = 'stage'
    }
    cfBgDeploy {
      cfTarget = 'stage'
    }
  }

  stage('Final Scans') {
    fortify()
  }

  stage ('Cleanup') {
    deleteDir()
  }
}
